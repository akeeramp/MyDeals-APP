var reflection={};!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c,d){function h(){!a&&this.init&&this.init.apply(this,arguments)}d&&(reflection[d]=h);var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return h.prototype=f,h.prototype.constructor=h,h.extend=arguments.callee,h}}();var Input=Class.extend({init:function(){this.reset()},reset:function(){this.left=!1,this.right=!1,this.accelerate=!1,this.up=!1,this.down=!1},bind:function(){},unbind:function(){},accelerate:!1,left:!1,up:!1,right:!1,down:!1}),KeyBoard=Input.extend({init:function(){this._super()},bind:function(){var a=this;$(document).on("keydown",function(b){return a.handler(b,!0)}),$(document).on("keyup",function(b){return a.handler(b,!1)})},unbind:function(){$(document).off("keydown"),$(document).off("keyup")},handler:function(a,b){switch(a.keyCode){case 57392:case 17:case 65:this.accelerate=b;break;case 40:this.down=b;break;case 39:this.right=b;break;case 37:this.left=b;break;case 38:case 32:this.up=b;break;default:return!0}return a.preventDefault(),!1}}),SoundManager=Class.extend({init:function(a,b){var c=0,d=document.createElement("audio");if(this.onload=b,this.soundNames=["jump","heart","enemy_die","grow","hurt","coffee","bantha","shoot","lifeupgrade"],this.musicNames=["game","invincible","die","success","gameover","sage","ending","menu","editor"],this.musicLoops=[!0,!1,!1,!1,!1,!0,!1,!0,!0],this.count=this.soundNames.length+this.musicNames.length,this.sounds=[],this.tracks=[],this.settings=a||{musicOn:!0},this.currentMusic=null,this.support="function"==typeof d.canPlayType&&(""!==d.canPlayType("audio/mpeg")||""!==d.canPlayType("audio/ogg")),this.toLoad=0,this.sides=0,this.support){for(var e=d.canPlayType("audio/ogg").match(/maybe|probably/i)?".ogg":".mp3",f=this,g=function(){c++<25&&f.toLoad>0?setTimeout(function(){g()},100):f.loaded()},h=0,c=this.soundNames.length;h<c;h++){f.increment();var i=document.createElement("audio");i.addEventListener("error",function(){f.decrement()},!1),i.addEventListener("loadeddata",function(){f.decrement()},!1),i.src=AUDIOPATH+f.soundNames[h]+e,i.preload="auto",f.sounds.push([i])}for(var h=0,c=this.musicNames.length;h<c;h++){f.increment();var i=document.createElement("audio");i.addEventListener("error",function(){f.decrement()},!1),i.addEventListener("loadeddata",function(){f.decrement()},!1),i.src=AUDIOPATH+f.musicNames[h]+e,f.musicLoops[h]?"boolean"==typeof i.loop?i.loop=!0:i.addEventListener("ended",function(){this.currentTime=0,this.play()},!1):i.addEventListener("ended",function(){f.sideMusicEnded()},!1),i.preload="auto",f.tracks.push(i)}b&&g()}else this.loaded()},loaded:function(){if(this.onload){var a=this;setTimeout(function(){a.onload()},10)}},increment:function(){++this.toLoad},decrement:function(){--this.toLoad},play:function(a){if(this.settings&&this.settings.musicOn&&this.support)for(var b=this.soundNames.length;b--;)if(this.soundNames[b]===a){for(var c=this.sounds[b],d=c.length;d--;){if(0===c[d].duration)return;if(c[d].ended)c[d].currentTime=0;else if(c[d].currentTime>0)continue;return void c[d].play()}var e=document.createElement("audio");return e.src=c[0].src,c.push(e),void e.play()}},pauseMusic:function(){this.support&&this.currentMusic&&this.currentMusic.pause()},playMusic:function(){this.support&&this.currentMusic&&this.settings.musicOn&&this.currentMusic.play()},sideMusicEnded:function(){this.sides--,0===this.sides&&(this.currentMusic=this.previous,this.playMusic())},sideMusic:function(a){var b=this;if(b.support){0===b.sides&&(b.previous=b.currentMusic,b.pauseMusic());for(var c=b.musicNames.length;c--;)if(b.musicNames[c]===a){b.currentMusic!==b.tracks[c]&&(b.sides++,b.currentMusic=b.tracks[c]);try{b.currentMusic.currentTime=0,b.playMusic()}catch(a){b.sideMusicEnded()}}}},music:function(a,b){if(this.support)for(var c=this.musicNames.length;c--;)if(this.musicNames[c]===a){var d=this.tracks[c];if(d===this.currentMusic)return;if(this.pauseMusic(),this.currentMusic=d,!this.support)return;try{b||(this.currentMusic.currentTime=0),this.playMusic()}catch(a){}}}}),Base=Class.extend({init:function(a,b){this.setPosition(a||0,b||0),this.clearFrames()},setPosition:function(a,b){this.x=a,this.y=b},getPosition:function(){return{x:this.x,y:this.y}},setImage:function(a,b,c){this.image={path:a,x:b,y:c}},setSize:function(a,b){this.width=a,this.height=b},getSize:function(){return{width:this.width,height:this.height}},setupFrames:function(a,b,c,d){if(d){if(this.frameID===d)return!0;this.frameID=d}return this.frameCount=0,this.currentFrame=0,this.frameTick=b?1e3/a/constants.interval:0,this.frames=b,this.rewindFrames=c,!1},clearFrames:function(){this.frameID=void 0,this.frames=0,this.currentFrame=0,this.frameTick=0},playFrame:function(){if(this.frameTick&&this.view&&(this.frameCount++,this.frameCount>=this.frameTick)){this.frameCount=0,this.currentFrame===this.frames&&(this.currentFrame=0);var a=this.view;a.css("background-position","-"+(this.image.x+this.width*((this.rewindFrames?this.frames-1:0)-this.currentFrame))+"px -"+this.image.y+"px"),this.currentFrame++}}}),Gauge=Base.extend({init:function(a,b,c,d,e,f){this._super(0,0),this.view=$("#"+a),this.setSize(this.view.width(),this.view.height()),this.setImage(this.view.css("background-image"),b,c),this.setupFrames(d,e,f)}}),Level=Base.extend({init:function(a){this.world=$("#"+a),this.nextCycles=0,this._super(0,0),this.input=[],this.reset(),this.heartGauge=new Gauge("heart",0,0,10,4,!0),this.liveGauge=new Gauge("live",0,48,6,6,!0)},reload:function(){var a={};return this.mario&&(a.lifes=this.mario.lifes-1,a.hearts=this.mario.hearts,a.lifes<0)?(this.playMusic("gameOver"),$(DIV).appendTo(this.world).addClass("gameover").css("left",this.x).html("Game Over"),void(this.deadCycles=Math.floor(5e3/constants.interval))):(this.pause(),this.reset(),this.load(this.raw),this.mario&&(this.mario.setLifes(a.lifes||0),this.mario.setHearts(a.hearts||0),this.invokeSameCallback()),void this.start())},setSameCallback:function(a){this.sameCallback=a},setNextCallback:function(a){this.nextCallback=a},invokeNextCallback:function(){this.nextCycles||this.nextCallback&&this.nextCallback()},invokeDeadCallback:function(){this.deadCycles||this.deadCallback&&this.deadCallback()},invokeSameCallback:function(){this.sameCallback&&this.sameCallback()},setDeadCallback:function(a){this.deadCallback=a},exportSaveGame:function(){var a={};return this.mario&&(a.lifes=this.mario.lifes,a.hearts=this.mario.hearts,a.state=this.mario.state,a.marioState=this.mario.marioState),a},importSaveGame:function(a){this.mario&&(this.mario.setLifes(a.lifes||0),this.mario.setHearts(a.hearts||0),this.mario.setState(a.state||size_states.small),this.mario.setMarioState(a.marioState||mario_states.normal))},setInput:function(a){this.input.push(a)},bindInput:function(){for(var a=this.input.length;a--;)this.input[a].bind()},clearInput:function(){for(var a=this.input.length;a--;)this.input[a].unbind()},getInput:function(){for(var a={left:!1,down:!1,right:!1,up:!1,accelerate:!1},b=this.input.length;b--;)for(var c in a)a[c]=a[c]||this.input[b][c];return a},load:function(a){this.active&&(this.loop&&this.pause(),this.reset()),this.setPosition(0,0),this.setSize(32*a.width,32*a.height),this.setImage(a.background),this.raw=a,this.id=a.id,this.active=!0;var b=a.data;a.data.splice(a.width);for(var c=0;c<a.width;c++){for(var d=[],e=0;e<a.height;e++)d.push("");this.obstacles.push(d)}for(var c=0,f=b.length;c<f;c++)for(var g=b[c],e=0,h=g.length;e<h;e++){var i=g[e];/^fig_/.test(i)&&(i=i.substr(4)),/_\dx\d$/.test(i)&&(i=i.substr(0,i.length-4)),reflection[i]&&new reflection[i](32*c,32*(h-e-1),this)}},next:function(){this.nextCycles=Math.floor(7e3/constants.interval)},getGridWidth:function(){return this.raw.width},getGridHeight:function(){return this.raw.height},setSounds:function(a){this.sounds=a},playSound:function(a){this.sounds&&this.sounds.play(a)},playMusic:function(a){this.sounds&&this.sounds.sideMusic(a)},reset:function(){this.active=!1,this.world.empty(),this.figures=[],this.obstacles=[],this.items=[],this.decorations=[],this.mario=void 0},tick:function(){if(this.nextCycles)return this.nextCycles--,void this.invokeNextCallback();if(this.deadCycles)return this.deadCycles--,void this.invokeDeadCallback();var c,d,a=0,b=0;for(a=this.figures.length;a--;){if(c=this.figures[a],c.dead)if(c.death())c.playFrame();else{if(c instanceof Mario)return this.reload();c.view.remove(),this.figures.splice(a,1)}else if(a)for(b=a;b--&&!c.dead;)d=this.figures[b],!d.dead&&q2q(c,d)&&(c.hit(d),d.hit(c));c.dead||(c.move(),c.playFrame())}for(a=this.items.length;a--;)this.items[a].playFrame();this.heartGauge.playFrame(),this.liveGauge.playFrame()},start:function(){var a=this;a.bindInput(),a.loop=setInterval(function(){a.tick.apply(a)},constants.interval)},pause:function(){clearInterval(this.loop),this.clearInput(),this.loop=void 0},setPosition:function(a,b){this._super(a,b),this.world.css("left",-a)},setImage:function(a){var b=BASEPATH+"backgrounds/"+((a<10?"0":"")+a)+".png";this.world.parent().css({backgroundImage:c2u(b),backgroundPosition:"0 -380px"}),this._super(b,0,0)},setSize:function(a,b){this._super(a,b)},setParallax:function(a){this.setPosition(a,this.y),this.world.parent().css("background-position","-"+Math.floor(a/3)+"px -380px")}}),Figure=Base.extend({init:function(a,b,c){this.view=$(DIV).addClass(CLS_FIGURE).appendTo(c.world),this.dead=!1,this.onground=!0,this.setState(size_states.small),this.setVelocity(0,0),this.direction=directions.none,this.level=c,this._super(a,b),c.figures.push(this)},setState:function(a){this.state=a},setImage:function(a,b,c){this.view.css({backgroundImage:a?c2u(a):"none",backgroundPosition:"-"+(b||0)+"px -"+(c||0)+"px"}),this._super(a,b,c)},setPosition:function(a,b){this.view.css({left:a,bottom:b}),this._super(a,b),this.setGridPosition(a,b)},setSize:function(a,b){this.view.css({width:a,height:b}),this._super(a,b)},setGridPosition:function(a,b){this.i=Math.floor((a+16)/32),this.j=Math.ceil(this.level.getGridHeight()-1-b/32),this.j>this.level.getGridHeight()&&this.die()},getGridPosition:function(a,b){return{i:this.i,j:this.j}},setVelocity:function(a,b){this.vx=a,this.vy=b,a>0?this.direction=directions.right:a<0&&(this.direction=directions.left)},getVelocity:function(){return{vx:this.vx,vy:this.vy}},hit:function(a){},collides:function(a,b,c,d,e){var f=this instanceof Hero;if(c=Math.max(c,0),a<0||b>=this.level.obstacles.length)return!0;if(d>=this.level.getGridHeight())return!1;for(var g=a;g<=b;g++)for(var h=d;h>=c;h--){var i=this.level.obstacles[g][h];if(i&&(i instanceof Item&&f&&(e===ground_blocking.bottom||i.blocking===ground_blocking.none)&&i.activate(this),(i.blocking&e)===e))return!0}return!1},move:function(){var a=this.vx,b=this.vy-constants.gravity,c=this.state,d=this.x,e=this.y,f=Math.sign(a),g=Math.sign(b),h=this.i,i=h,j=Math.ceil(this.level.getGridHeight()-c-(e+31)/32),k=this.j,l=0,m=ground_blocking.none,n=!1,o=Math.floor((d+16+a)/32);f>0?(l=o-i,o=i,m=ground_blocking.left):f<0&&(l=h-o,o=h,m=ground_blocking.right),d+=a;for(var p=0;p<l;p++){if(this.collides(o+f,o+f,j,k,m)){a=0,d=32*o+15*f;break}o+=f,h+=f,i+=f}g>0?(o=Math.ceil(this.level.getGridHeight()-c-(e+31+b)/32),l=j-o,o=j,m=ground_blocking.bottom):g<0?(o=Math.ceil(this.level.getGridHeight()-1-(e+b)/32),l=o-k,o=k,m=ground_blocking.top):l=0,e+=b;for(var p=0;p<l;p++){if(this.collides(h,i,o-g,o-g,m)){n=g<0,b=0,e=this.level.height-32*(o+1)-(g>0?32*(c-1):0);break}o-=g}this.onground=n,this.setVelocity(a,b),this.setPosition(d,e)},death:function(){return!1},die:function(){this.dead=!0}}),Matter=Base.extend({init:function(a,b,c,d){this.blocking=c,this.view=$(DIV).addClass(CLS_MATTER).appendTo(d.world),this.level=d,this._super(a,b),this.setSize(32,32),this.addToGrid(d)},addToGrid:function(a){a.obstacles[this.x/32][this.level.getGridHeight()-1-this.y/32]=this},setImage:function(a,b,c){this.view.css({backgroundImage:a?c2u(a):"none",backgroundPosition:"-"+(b||0)+"px -"+(c||0)+"px"}),this._super(a,b,c)},setPosition:function(a,b){this.view.css({left:a,bottom:b}),this._super(a,b)}}),Ground=Matter.extend({init:function(a,b,c,d){this._super(a,b,c,d)}}),TopGrass=Ground.extend({init:function(a,b,c){var d=ground_blocking.top;this._super(a,b,d,c),this.setImage(images.objects,888,404)}},"grass_top"),TopRightGrass=Ground.extend({init:function(a,b,c){var d=ground_blocking.top+ground_blocking.right;this._super(a,b,d,c),this.setImage(images.objects,922,404)}},"grass_top_right"),TopLeftGrass=Ground.extend({init:function(a,b,c){var d=ground_blocking.left+ground_blocking.top;this._super(a,b,d,c),this.setImage(images.objects,854,404)}},"grass_top_left"),RightGrass=Ground.extend({init:function(a,b,c){var d=ground_blocking.right;this._super(a,b,d,c),this.setImage(images.objects,922,438)}},"grass_right"),LeftGrass=Ground.extend({init:function(a,b,c){var d=ground_blocking.left;this._super(a,b,d,c),this.setImage(images.objects,854,438)}},"grass_left"),TopRightRoundedGrass=Ground.extend({init:function(a,b,c){var d=ground_blocking.top;this._super(a,b,d,c),this.setImage(images.objects,922,506)}},"grass_top_right_rounded"),TopLeftRoundedGrass=Ground.extend({init:function(a,b,c){var d=ground_blocking.top;this._super(a,b,d,c),this.setImage(images.objects,854,506)}},"grass_top_left_rounded"),TopRightGrassSoil=Ground.extend({init:function(a,b,c){var d=ground_blocking.top;this._super(a,b,d,c),this.setImage(images.objects,990,506)}},"grass_top_right_rounded_soil"),TopLeftGrassSoil=Ground.extend({init:function(a,b,c){var d=ground_blocking.top;this._super(a,b,d,c),this.setImage(images.objects,956,506)}},"grass_top_left_rounded_soil"),Stone=Ground.extend({init:function(a,b,c){var d=ground_blocking.all;this._super(a,b,d,c),this.setImage(images.objects,550,160)}},"stone"),BrownBlock=Ground.extend({init:function(a,b,c){var d=ground_blocking.all;this._super(a,b,d,c),this.setImage(images.objects,514,194)}},"brown_block"),RightTopPipe=Ground.extend({init:function(a,b,c){var d=ground_blocking.all;this._super(a,b,d,c),this.setImage(images.objects,36,358)}},"pipe_top_right"),LeftTopPipe=Ground.extend({init:function(a,b,c){var d=ground_blocking.all;this._super(a,b,d,c),this.setImage(images.objects,2,358)}},"pipe_top_left"),RightPipe=Ground.extend({init:function(a,b,c){var d=ground_blocking.right+ground_blocking.bottom;this._super(a,b,d,c),this.setImage(images.objects,36,390)}},"pipe_right"),LeftPipe=Ground.extend({init:function(a,b,c){var d=ground_blocking.left+ground_blocking.bottom;this._super(a,b,d,c),this.setImage(images.objects,2,390)}},"pipe_left"),Decoration=Matter.extend({init:function(a,b,c){this._super(a,b,ground_blocking.none,c),c.decorations.push(this)},setImage:function(a,b,c){this.view.css({backgroundImage:a?c2u(a):"none",backgroundPosition:"-"+(b||0)+"px -"+(c||0)+"px"}),this._super(a,b,c)},setPosition:function(a,b){this.view.css({left:a,bottom:b}),this._super(a,b)}}),TopRightCornerGrass=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,612,868)}},"grass_top_right_corner"),TopLeftCornerGrass=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,648,868)}},"grass_top_left_corner"),Soil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,888,438)}},"soil"),RightSoil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,922,540)}},"soil_right"),LeftSoil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,854,540)}},"soil_left"),RightBush=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,382,928)}},"bush_right"),RightMiddleBush=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,314,928)}},"bush_middle_right"),MiddleBush=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,348,928)}},"bush_middle"),LeftMiddleBush=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,212,928)}},"bush_middle_left"),LeftBush=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,178,928)}},"bush_left"),RightPlantedSoil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,782,832)}},"planted_soil_right"),MiddlePlantedSoil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,748,832)}},"planted_soil_middle"),LeftPlantedSoil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,714,832)}},"planted_soil_left"),RightPipeGrass=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,36,424)}},"pipe_right_grass"),LeftPipeGrass=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,2,424)}},"pipe_left_grass"),RightPipeSoil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,36,458)}},"pipe_right_soil"),LeftPipeSoil=Decoration.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,2,458)}},"pipe_left_soil"),Item=Matter.extend({init:function(a,b,c,d){this.isBouncing=!1,this.bounceCount=0,this.bounceFrames=Math.floor(50/constants.interval),this.bounceStep=Math.ceil(10/this.bounceFrames),this.bounceDir=1,this.isBlocking=c,this._super(a,b,c?ground_blocking.all:ground_blocking.none,d),this.activated=!1,this.addToLevel(d),this.backDecoration=this.detectBackDecoration(d)},detectBackDecoration:function(a){if(this.level.raw){for(var b="soil",c=[1,-1],d=0,e=0;e<2;e++)for(var f=0;f<c.length;f++){var g=Math.floor(this.x/32),h=Math.floor(14-this.y/32);if(0===e?g+=c[f]:h+=c[f],!(g<0||g>=this.level.raw.width||h<0||h>14))if(this.level.raw.data[g][h].indexOf(b)>-1)d++;else{for(var i=!0;"heart"===this.level.raw.data[g][h];)if(0===e?g+=c[f]:h+=c[f],g<0||g>=this.level.raw.width||h<0||h>14){i=!1;break}i&&this.level.raw.data[g][h].indexOf(b)>-1&&d++}}return d>1?$(DIV).addClass(CLS_MATTER).css({backgroundImage:c2u(images.objects),backgroundPosition:"-888px -438px",zIndex:0,bottom:this.y,left:this.x}).appendTo(this.view.parent()):void 0}},addToLevel:function(a){a.items.push(this)},activate:function(a){this.activated=!0},bounce:function(){this.isBouncing=!0;for(var a=this.level.figures.length;a--;){var b=this.level.figures[a];b.y===this.y+32&&b.x>=this.x-16&&b.x<=this.x+16&&(b instanceof ItemFigure?b.setVelocity(b.vx,constants.bounce):b.die())}},playFrame:function(){this.isBouncing&&(this.view.css({bottom:(this.bounceDir>0?"+":"-")+"="+this.bounceStep+"px"}),this.bounceCount+=this.bounceDir,this.bounceCount===this.bounceFrames?this.bounceDir=-1:0===this.bounceCount&&(this.bounceDir=1,this.isBouncing=!1)),this._super()}}),Heart=Item.extend({init:function(a,b,c){this._super(a,b,!1,c),this.setImage(images.objects,0,0),this.setupFrames(10,4,!0)},activate:function(a){this.activated||(this.level.playSound("heart"),a.addHeart(),this.remove()),this._super(a)},remove:function(){this.view.remove()}},"heart"),HeartBoxHeart=Heart.extend({init:function(a,b,c){this._super(a,b,c),this.setImage(images.objects,96,0),this.clearFrames(),this.view.hide(),this.count=0,this.frames=Math.floor(150/constants.interval),this.step=Math.ceil(30/this.frames)},remove:function(){},addToGrid:function(){},addToLevel:function(){},activate:function(a){this._super(a),this.view.show().css({bottom:"+=8px"})},act:function(){return this.view.css({bottom:"+="+this.step+"px"}),this.count++,this.count===this.frames}}),HeartBox=Item.extend({init:function(a,b,c,d){this._super(a,b,!0,c),this.setImage(images.objects,346,328),this.setAmount(d||1)},setAmount:function(a){this.items=[],this.actors=[];for(var b=0;b<a;b++)this.items.push(new HeartBoxHeart(this.x,this.y,this.level))},activate:function(a){if(!this.isBouncing&&this.items.length){this.bounce();var b=this.items.pop();b.activate(a),this.actors.push(b),this.items.length||this.setImage(images.objects,514,194)}this._super(a)},playFrame:function(){for(var a=this.actors.length;a--;)this.actors[a].act()&&(this.actors[a].view.remove(),this.actors.splice(a,1));this._super()}},"heartbox"),MultipleHeartBox=HeartBox.extend({init:function(a,b,c){this._super(a,b,c,8)}},"multiple_heartbox"),ItemFigure=Figure.extend({init:function(a,b,c){this._super(a,b,c)}}),StarBox=Item.extend({init:function(a,b,c){this._super(a,b,!0,c),this.setImage(images.objects,96,33),this.star=new Star(a,b,c),this.setupFrames(8,4,!1)},activate:function(a){this.activated||(this.star.release(),this.clearFrames(),this.bounce(),this.setImage(images.objects,514,194)),this._super(a)}},"starbox"),Star=ItemFigure.extend({init:function(a,b,c){this._super(a,b+32,c),this.active=!1,this.setSize(32,32),this.setImage(images.objects,32,69),this.view.hide()},release:function(){this.taken=4,this.active=!0,this.level.playSound("coffee"),this.view.show(),this.setVelocity(constants.star_vx,constants.star_vy),this.setupFrames(10,2,!1)},collides:function(a,b,c,d,e){return!1},move:function(){this.active&&(this.vy+=this.vy<=-constants.star_vy?constants.gravity:constants.gravity/2,this._super()),this.taken&&this.taken--},hit:function(a){!this.taken&&this.active&&a instanceof Mario&&(a.invincible(),this.die())}}),CoffeeBox=Item.extend({init:function(a,b,c){this._super(a,b,!0,c),this.setImage(images.objects,96,33),this.max_mode=coffee_mode.donut,this.coffee=new Coffee(a,b,c),this.setupFrames(8,4,!1)},activate:function(a){this.activated||(a.state===size_states.small||this.max_mode===coffee_mode.coffee?this.coffee.release(coffee_mode.coffee):this.coffee.release(coffee_mode.donut),this.clearFrames(),this.bounce(),this.setImage(images.objects,514,194)),this._super(a)}},"coffeebox"),Coffee=ItemFigure.extend({init:function(a,b,c){this._super(a,b,c),this.active=!1,this.setSize(32,32),this.setImage(images.objects,582,60),this.released=0,this.view.css("z-index",94).hide()},release:function(a){this.released=4,this.level.playSound("coffee"),a===coffee_mode.donut&&this.setImage(images.objects,548,60),this.mode=a,this.view.show()},move:function(){this.active?(this._super(),this.mode===coffee_mode.coffee&&0===this.vx&&this.setVelocity(this.direction===directions.right?-constants.coffee_v:constants.coffee_v,this.vy)):this.released&&(this.released--,this.setPosition(this.x,this.y+8),this.released||(this.active=!0,this.view.css("z-index",99),this.mode===coffee_mode.coffee&&this.setVelocity(constants.coffee_v,constants.gravity)))},hit:function(a){this.active&&a instanceof Mario&&(this.mode===coffee_mode.coffee?a.grow():this.mode===coffee_mode.donut&&a.shooter(),this.die())}}),GoTeamBox=Item.extend({init:function(a,b,c){this._super(a,b,!0,c),this.setImage(images.objects,1120,680),this.max_mode=coffee_mode.donut,this.coffee=new Coffee(a,b,c),this.setupFrames(1,4,!1)},activate:function(a){this.activated||(a.state===size_states.small||this.max_mode===coffee_mode.coffee?this.coffee.release(coffee_mode.coffee):this.coffee.release(coffee_mode.donut),this.clearFrames(),this.bounce(),this.setImage(images.objects,514,194)),this._super(a)}},"goteambox"),Bullet=Figure.extend({init:function(a){this._super(a.x+(a.direction===directions.right?31:0),a.y+14,a.level),this.parent=a,this.setImage(images.sprites,252,61),this.setSize(16,16),this.direction=a.direction,this.vy=0,this.life=Math.ceil(2e3/constants.interval),this.speed=constants.bullet_v,this.vx=this.direction===directions.right?this.speed:-this.speed},setVelocity:function(a,b){if(this._super(a,b),0===this.vx){var c=this.speed*Math.sign(this.speed);this.vx=this.direction===directions.right?-c:c}this.onground&&(this.vy=constants.bounce)},move:function(){--this.life?this._super():this.die()},hit:function(a){a instanceof Mario||a instanceof Bantha||(a.die(),this.die())}}),Hero=Figure.extend({init:function(a,b,c){this._super(a,b,c)}}),Mario=Hero.extend({init:function(a,b,c){this.standSprites=[[[{x:256,y:0},{x:64,y:0}],[{x:0,y:0},{x:96,y:0}]],[[{x:256,y:88},{x:64,y:88}],[{x:0,y:88},{x:96,y:88}]],[[{x:256,y:150},{x:64,y:150}],[{x:0,y:150},{x:96,y:150}]]],this.crouchSprites=[[{x:128,y:0},{x:160,y:0}],[{x:128,y:88},{x:160,y:88}],[{x:128,y:150},{x:160,y:150}]],this.deadly=0,this.invulnerable=0,this._super(a,b,c),this.blinking=0,this.setSize(32,46),this.cooldown=0,c.mario=this,this.setMarioState(mario_states.normal),this.setLifes(constants.start_lives),this.setHearts(0),this.deathBeginWait=Math.floor(700/constants.interval),this.deathEndWait=0,this.deathFrames=Math.floor(600/constants.interval),this.deathStepUp=Math.ceil(200/this.deathFrames),this.deathDir=1,this.deathCount=0,this.direction=directions.right,this.setImage(images.sprites,0,0),this.crouching=!1,this.fast=!1},setMarioState:function(a){this.marioState=a},setState:function(a){a!==this.state&&(this.setMarioState(mario_states.normal),a===size_states.small?this.setSize(32,46):this.setSize(32,62),this._super(a))},setPosition:function(a,b){this._super(a,b);var c=this.level.width-640,d=this.x<=210?0:this.x>=this.level.width-230?c:c/(this.level.width-440)*(this.x-210);this.level.setParallax(d),this.onground&&this.x>=this.level.width-128&&this.victory()},input:function(a){this.fast=a.accelerate,this.crouching=a.down,this.crouching||(this.onground&&a.up&&this.jump(),a.accelerate&&this.marioState===mario_states.fire&&this.shoot(),a.right||a.left?this.walk(a.left,a.accelerate):this.vx=0)},victory:function(){this.level.playMusic("success"),this.clearFrames(),this.blinking=0,this.invulnerable=0,this.view.show();var a;this.state===size_states.small?a=0:this.marioState===mario_states.normal?a=88:this.marioState===mario_states.fire&&(a=150),this.setImage(images.sprites,384,a),this.level.next()},shoot:function(){this.cooldown||(this.cooldown=constants.cooldown,this.level.playSound("shoot"),new Bullet(this))},setVelocity:function(a,b){this.crouching?(a=0,this.crouch()):this.onground&&a>0?this.walkRight():this.onground&&a<0?this.walkLeft():this.stand(),this._super(a,b)},blink:function(a){this.blinking=Math.max(2*a*constants.blinkfactor,this.blinking||0)},invincible:function(){this.level.playMusic("invincibility"),this.deadly=Math.floor(constants.invincible/constants.interval),this.invulnerable=this.deadly,this.blink(Math.ceil(this.deadly/(2*constants.blinkfactor)))},grow:function(){this.state===size_states.small&&(this.level.playSound("grow"),this.setState(size_states.big),this.blink(3))},shooter:function(){this.state===size_states.small?this.grow():this.level.playSound("grow"),this.setMarioState(mario_states.fire)},walk:function(a,b){this.vx=constants.walking_v*(b?2:1)*(a?-1:1)},walkRight:function(){this.state===size_states.small?this.setupFrames(8,2,!1,"WalkRightSmall")||this.setImage(images.sprites,32,0):this.marioState===mario_states.normal?this.setupFrames(9,2,!1,"WalkRightBig")||this.setImage(images.sprites,32,88):this.marioState===mario_states.fire&&(this.setupFrames(9,2,!1,"WalkRightFire")||this.setImage(images.sprites,32,150))},walkLeft:function(){this.state===size_states.small?this.setupFrames(8,2,!1,"WalkLeftSmall")||this.setImage(images.sprites,288,0):this.marioState===mario_states.normal?this.setupFrames(9,2,!1,"WalkLeftBig")||this.setImage(images.sprites,288,88):this.marioState===mario_states.fire&&(this.setupFrames(9,2,!1,"WalkLeftFire")||this.setImage(images.sprites,288,150))},stand:function(){var a=this.state+this.marioState-1,b=this.standSprites[a][this.direction===directions.left?0:1][this.onground?0:1];this.setImage(images.sprites,b.x,b.y),this.clearFrames()},crouch:function(){var a=this.state+this.marioState-1,b=this.crouchSprites[a][this.direction===directions.left?0:1];this.setImage(images.sprites,b.x,b.y),this.clearFrames()},jump:function(){this.level.playSound("jump"),this.vy=constants.jumping_v},move:function(){this.input(this.level.getInput()),this._super()},addHeart:function(){this.setHearts(this.hearts+1)},playFrame:function(){this.blinking&&(this.blinking%constants.blinkfactor===0&&this.view.toggle(),this.blinking--),this.cooldown&&this.cooldown--,this.deadly&&this.deadly--,this.invulnerable&&this.invulnerable--,this._super()},setHearts:function(a){this.hearts=a,this.hearts>=constants.max_hearts&&(this.addLife(),this.hearts-=constants.max_hearts),this.level.world.parent().children("#heartNumber").text(this.hearts)},addLife:function(){this.level.playSound("lifeupgrade"),this.setLifes(this.lifes+1)},setLifes:function(a){this.lifes=a,this.level.world.parent().children("#liveNumber").text(this.lifes)},death:function(){return this.deathBeginWait?(this.deathBeginWait--,!0):this.deathEndWait?--this.deathEndWait:(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames?this.deathDir=-1:0===this.deathCount&&(this.deathEndWait=Math.floor(1800/constants.interval)),!0)},die:function(){this.setMarioState(mario_states.normal),this.deathStepDown=Math.ceil(240/this.deathFrames),this.setSize(32,48),this.setupFrames(9,2,!0),this.setImage(images.sprites,416,0),this.level.playMusic("die"),this._super()},hurt:function(a){if(this.deadly)a.die();else{if(this.invulnerable)return;this.state===size_states.small?this.die():(this.invulnerable=Math.floor(constants.invulnerable/constants.interval),this.blink(Math.ceil(this.invulnerable/(2*constants.blinkfactor))),this.setState(size_states.small),this.level.playSound("hurt"))}}},"mario"),Sage=Hero.extend({init:function(a,b,c){this.width=80,this._super(a,b,c),this.setSize(46,64),this.direction=directions.right,this.setImage(images.sage,0,80)},setVelocity:function(a,b){this._super(a,b),0!==a?this.setupFrames(6,4,!1,"Walk")||this.setImage(images.sage,138,80):this.frameTick&&(this.clearFrames(),this.setImage(images.sage,0,80))}},"sage"),BigMario=Hero.extend({init:function(a,b,c){this._super(a,b,c),this.direction=directions.right,this.setSize(32,62),this.setImage(images.sprites,0,88)},setVelocity:function(a,b){this._super(a,b),0!==a?this.setupFrames(9,2,!1,"WalkRightBig")||this.setImage(images.sprites,32,88):this.frameTick&&(this.clearFrames(),this.setImage(images.sprites,0,88))}},"bigmario"),Enemy=Figure.extend({init:function(a,b,c){this._super(a,b,c),this.speed=0},hide:function(){this.invisible=!0,this.view.hide()},show:function(){this.invisible=!1,this.view.show()},move:function(){if(!this.invisible&&(this._super(),0===this.vx)){var a=this.speed*Math.sign(this.speed);this.setVelocity(this.direction===directions.right?-a:a,this.vy)}},collides:function(a,b,c,d,e){if(this.j+1<this.level.getGridHeight())for(var f=a;f<=b;f++){if(f<0||f>=this.level.getGridWidth())return!0;var g=this.level.obstacles[f][this.j+1];if(!g||(g.blocking&ground_blocking.top)!==ground_blocking.top)return!0}return this._super(a,b,c,d,e)},setSpeed:function(a){this.speed=a,this.setVelocity(-a,0)},hurt:function(a){this.die()},hit:function(a){this.invisible||a instanceof Mario&&(a.vy<0&&a.y-a.vy>=this.y+32*this.state?(a.setVelocity(a.vx,constants.bounce),this.hurt(a)):a.hurt(this))}}),Jawa=Enemy.extend({init:function(a,b,c){this._super(a,b,c),this.setSize(34,32),this.setSpeed(constants.jawa_v),this.death_mode=death_modes.normal,this.deathCount=0},setVelocity:function(a,b){this._super(a,b),this.direction===directions.left?this.setupFrames(6,2,!1,"LeftWalk")||this.setImage(images.enemies,34,188):this.setupFrames(6,2,!0,"RightWalk")||this.setImage(images.enemies,0,228)},death:function(){if(this.death_mode===death_modes.normal)return--this.deathCount;if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+this.deathStep+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0},die:function(){this.clearFrames(),this.death_mode===death_modes.normal?(this.level.playSound("enemy_die"),this.setImage(images.enemies,102,228),
this.deathCount=Math.ceil(600/constants.interval)):this.death_mode===death_modes.bantha&&(this.level.playSound("bantha"),this.setImage(images.enemies,68,this.direction===directions.right?228:188),this.deathFrames=Math.floor(250/constants.interval),this.deathDir=1,this.deathStep=Math.ceil(150/this.deathFrames)),this._super()}},"jawa"),Bantha=Enemy.extend({init:function(a,b,c){this._super(a,b,c),this.setSize(54,32),this.speed=0,this.setImage(images.enemies,0,494)},activate:function(a,b){this.setupFrames(6,4,!1),this.setPosition(a,b),this.show()},takeBack:function(a){a.setBantha(this)&&this.clearFrames()},move:function(){this._super()},hit:function(a){this.invisible||(this.vx?a instanceof Mario?a.y>=this.y+this.height/2?(this.setSpeed(0),a.setVelocity(a.vx,constants.bounce)):a.hurt(this):(a.deathMode=death_modes.bantha,a.die()):a instanceof Mario?(this.setSpeed(a.direction===directions.right?-constants.bantha_v:constants.bantha_v),a.setVelocity(a.vx,constants.bounce)):a instanceof TuskenRaider&&a.state===size_states.small&&this.takeBack(a))},collides:function(a,b,c,d,e){if(a<0||b>=this.level.obstacles.length)return!0;if(c<0||d>=this.level.getGridHeight())return!1;for(var f=a;f<=b;f++)for(var g=d;g>=c;g--){var h=this.level.obstacles[f][g];if(h&&(h.blocking&e)===e)return!0}return!1}},"bantha"),TuskenRaider=Enemy.extend({init:function(a,b,c){this.walkSprites=[[{x:54,y:382},{x:0,y:437}],[{x:54,y:266},{x:0,y:325}]],this._super(a,b,c),this.wait=0,this.deathMode=death_modes.normal,this.deathFrames=Math.floor(250/constants.interval),this.deathStepUp=Math.ceil(150/this.deathFrames),this.deathStepDown=Math.ceil(182/this.deathFrames),this.deathDir=1,this.deathCount=0,this.setSize(54,54),this.setBantha(new Bantha(a,b,c))},setBantha:function(a){return!this.bantha&&!this.wait&&(this.bantha=a,a.hide(),this.setState(size_states.big),!0)},setState:function(a){this._super(a),a===size_states.big?this.setSpeed(constants.big_turtle_v):this.setSpeed(constants.small_turtle_v)},setVelocity:function(a,b){this._super(a,b);var c=this.direction===directions.right,d=this.walkSprites[this.state-1][c?1:0],e=Math.sign(a)+"-"+this.state;this.setupFrames(6,2,c,e)||this.setImage(images.enemies,d.x,d.y)},die:function(){this._super(),this.clearFrames(),this.deathMode===death_modes.normal?(this.level.playSound("enemy_die"),this.deathFrames=Math.floor(600/constants.interval),this.setImage(images.enemies,140,437)):this.deathMode===death_modes.bantha&&(this.level.playSound("bantha"),this.setImage(images.enemies,68,this.state===size_states.small?this.direction===directions.right?437:382:325))},death:function(){if(this.deathMode===death_modes.normal)return--this.deathFrames;if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0},move:function(){this.wait&&this.wait--,this._super()},hurt:function(a){return this.state===size_states.small?this.die():(this.level.playSound("enemy_die"),this.wait=constants.bantha_wait,this.setState(size_states.small),this.bantha.activate(this.x,this.y),void(this.bantha=void 0))},hit:function(a){this.wait||this._super(a)}},"tuskenraider"),SpikedTurtle=Enemy.extend({init:function(a,b,c){this._super(a,b,c),this.setSize(34,32),this.setSpeed(constants.spiked_turtle_v),this.deathFrames=Math.floor(250/constants.interval),this.deathStepUp=Math.ceil(150/this.deathFrames),this.deathStepDown=Math.ceil(182/this.deathFrames),this.deathDir=1,this.deathCount=0},setVelocity:function(a,b){this._super(a,b),this.direction===directions.left?this.setupFrames(4,2,!0,"LeftWalk")||this.setImage(images.enemies,0,106):this.setupFrames(6,2,!1,"RightWalk")||this.setImage(images.enemies,34,147)},death:function(){if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0},die:function(){this.level.playSound("bantha"),this.clearFrames(),this._super(),this.setImage(images.enemies,68,this.direction===directions.left?106:147)},hit:function(a){this.invisible||a instanceof Mario&&a.hurt(this)}},"spikedturtle"),BobaFett=Enemy.extend({init:function(a,b,c){this._super(a,b,c),this.setSize(41,64),this.setMode(bobafett_mode.sleep,directions.left)},die:function(){},setMode:function(a,b){this.mode===a&&this.direction===b||(this.mode=a,this.direction=b,this.setImage(images.bobafett,41*(a+b-1),0))},move:function(){var a=this.level.mario;if(a&&Math.abs(this.x-a.x)<=800){var b=Math.sign(a.x-this.x),c=.5*Math.sign(a.y-this.y),d=b?b+2:this.direction,e=a.direction===d?bobafett_mode.awake:bobafett_mode.sleep;this.setMode(e,d),e&&this.setPosition(this.x+b,this.y+c)}else this.setMode(bobafett_mode.sleep,this.direction)},hit:function(a){a instanceof Mario&&a.hurt(this)}},"bobafett"),Sarlacc=Enemy.extend({init:function(a,b,c){this._super(a,b,c),this.setSize(34,42),this.setupFrames(5,2,!0),this.setImage(images.enemies,0,3)},setVelocity:function(a,b){this._super(0,0)},die:function(){this.level.playSound("bantha"),this.clearFrames(),this._super()},hit:function(a){this.invisible||a instanceof Mario&&a.hurt(this)}}),StaticSarlacc=Sarlacc.extend({init:function(a,b,c){this._super(a,b,c),this.deathFrames=Math.floor(250/constants.interval),this.deathStepUp=Math.ceil(100/this.deathFrames),this.deathStepDown=Math.ceil(132/this.deathFrames),this.deathDir=1,this.deathCount=0},die:function(){this._super(),this.setImage(images.enemies,68,3)},death:function(){if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0}},"staticsarlacc"),PipeSarlacc=Sarlacc.extend({init:function(a,b,c){this.bottom=b-48,this.top=b-6,this._super(a+16,b-6,c),this.setDirection(directions.down),this.setImage(images.enemies,0,56),this.deathFrames=Math.floor(250/constants.interval),this.deathFramesExtended=6,this.deathFramesExtendedActive=!1,this.deathStep=Math.ceil(100/this.deathFrames),this.deathDir=1,this.deathCount=0,this.view.css("z-index",95)},setGridPosition:function(a,b){this.i=Math.floor(a/32),this.j=Math.ceil(this.level.getGridHeight()-1-(b+6)/32),this.j>this.level.getGridHeight()&&this.die()},setDirection:function(a){this.direction=a},setPosition:function(a,b){b!==this.bottom&&b!==this.top||(this.minimum=constants.pipesarlacc_count,this.setDirection(this.direction===directions.up?directions.down:directions.up)),this._super(a,b)},blocked:function(){if(this.y===this.bottom){var a=!1;this.y+=48;for(var b=this.level.figures.length;b--;)if(this.level.figures[b]!=this&&q2q(this.level.figures[b],this)){a=!0;break}return this.y-=48,a}return!1},move:function(){0===this.minimum?this.blocked()||this.setPosition(this.x,this.y-(this.direction-3)*constants.pipesarlacc_v):this.minimum--},die:function(){this._super(),this.setImage(images.enemies,68,56)},death:function(){return this.deathFramesExtendedActive?(this.setPosition(this.x,this.y-8),--this.deathFramesExtended):(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+this.deathStep+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames?this.deathDir=-1:0===this.deathCount&&(this.deathFramesExtendedActive=!0),!0)}},"pipesarlacc");